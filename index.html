<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>è‡ªè¨‚è©å½™å­¸ç¿’å¡ v8.8 (ç©©å®šä¿®å¾©ç‰ˆ)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: #f0f2f5;
            --card: #ffffff;
            --accent: #2563eb;
            --known: #10b981;
            --unknown: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
        }
        html, body { height: 100%; margin: 0; }
        body {
            font-family:'Noto Sans','Helvetica Neue',Arial,sans-serif;
            background:var(--bg);
            color:var(--text);
            padding: 0;
            display:flex;
            flex-direction:column;
            align-items:center;
            width: 100%;
            overflow: hidden;
        }

        #learning-interface {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            height: 100%;
            padding: 15px 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #quiz-interface {
            width:100%;max-width:760px;background:var(--card);padding:20px;border-radius:16px;display:none;
            box-shadow:0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow-y: auto;
            max-height: 90vh;
            margin: 20px;
        }

        h1{
            margin: 5px 0;
            font-size:20px;
            color:var(--text);
            font-weight: 800;
            flex-shrink: 0;
            text-align: center;
        }

        /* è¨­å®šèˆ‡æŒ‰éˆ•å€å¡Š */
        .file-controls, .session-controls {
            width: 100%; max-width: 760px; background: var(--card); 
            border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0; margin-bottom: 8px;
        }
        
        .file-controls { display: none; padding: 15px; border: 1px solid #e5e7eb; }
        .session-controls { padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }

        .toggle-setup-btn {
            width: 100%; max-width: 760px; padding: 8px; font-weight: 700;
            border: 1px dashed var(--accent); background: #eff6ff; color: var(--accent);
            border-radius: 8px; cursor: pointer; margin-bottom: 5px; flex-shrink: 0;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .import-btn, .export-btn, .small-btn, .challenge-btn {
            border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; font-size: 14px;
            transition: filter 0.2s; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
        }
        .import-btn { background: var(--accent); color: #fff; }
        .export-btn { background: var(--known); color: #fff; }
        .small-btn { background: #fff; border: 1px solid #d1d5db; color: var(--text); }
        .challenge-btn { background-color: #f59e0b; color: white; }
        .small-btn:active, .import-btn:active { transform: scale(0.98); }
        .deck-select { padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; flex-grow: 1; }

        /* ç‹€æ…‹åˆ— */
        .progress-indicator {
            width: 100%; max-width: 760px; padding: 10px 15px;
            border-radius: 12px; background: #fff; border: 1px solid #e5e7eb;
            flex-shrink: 0; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .progress-info { font-size: 13px; color: var(--text-light); margin-bottom: 5px; text-align: center; }
        .progress-bar-container { width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        
        .status-summary { display: flex; justify-content: space-around; margin-top: 8px; gap: 5px; }
        .status-btn {
            background: none; border: none; font-weight: 700; cursor: pointer; font-size: 15px;
            padding: 5px 10px; border-radius: 6px; transition: background 0.2s;
        }
        .status-btn:hover { background-color: #f3f4f6; }
        
        /* å¡ç‰‡å€åŸŸ */
        .card-container {
            width: 100%; max-width: 760px;
            flex: 1; 
            min-height: 200px; 
            perspective: 1000px;
            position: relative;
            margin-bottom: 10px;
        }
        .flashcard {
            width: 100%; height: 100%;
            position: relative; transition: transform 0.6s; transform-style: preserve-3d;
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-radius: 16px; background: white;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            padding: 15px; border-radius: 16px; background: var(--card);
            text-align: center; overflow: hidden;
        }
        
        .card-face-content {
             width: 100%; max-height: 100%; overflow-y: auto;
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             padding: 5px; box-sizing: border-box;
        }

        .card-front { color: var(--accent); background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); }
        .card-back { transform: rotateY(180deg); background: var(--accent); color: #fff; }

        /* å–®å­—æ’ç‰ˆ */
        .word-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        #word-en {
            font-size: 56px; 
            font-weight: 800;
            line-height: 1.1;
            word-break: break-word;
        }

        .audio-btn {
            font-size: 36px;
            cursor: pointer;
            color: var(--accent);
            background: rgba(37, 99, 235, 0.1);
            width: 56px; height: 56px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: transform 0.1s, background 0.2s;
        }
        .audio-btn:active { transform: scale(0.9); }
        .audio-btn:hover { background: rgba(37, 99, 235, 0.2); }

        .phonetic {
            font-family: 'Noto Sans', sans-serif; font-size: 24px; color: var(--text-light);
            margin-top: 10px; font-weight: 500;
        }
        
        #word-cn { font-size: 42px; font-weight: 800; margin-bottom: 15px; line-height: 1.3; }
        .definition {
            font-size: 20px; font-weight: 400; opacity: 0.95; margin-top: 15px;
            line-height: 1.5; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;
        }

        .srs-badge {
            position: absolute; top: 10px; right: 10px; font-size: 12px; 
            padding: 4px 8px; border-radius: 10px; background: rgba(0,0,0,0.1);
        }

        /* åº•éƒ¨æŒ‰éˆ•åˆ— */
        .controls-row {
            width: 100%; max-width: 760px; display: flex; gap: 10px;
            justify-content: space-between; align-items: center;
            flex-shrink: 0; padding-bottom: 10px; z-index: 20;
            background-color: var(--bg); 
        }
        .nav-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 1px solid #d1d5db; 
            background: #fff; font-size: 24px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 10px; border: none; 
            font-weight: 700; font-size: 18px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        body.autoplaying .nav-btn, body.autoplaying .action-btn { opacity: 0.5; pointer-events: none; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        
        /* è¼¸å…¥æ¡† */
        .control-group{display:flex;gap:10px;align-items:center; margin-bottom: 10px;}
        input[type=file]{padding:6px;border-radius:6px; border: 1px solid #d1d5db; background: #f9fafb; width: 100%;}
        textarea{width:100%;height:120px;border-radius:8px;padding:10px;border:1px solid #d1d5db;font-family:inherit; resize: vertical; margin-bottom: 10px;}

        /* RWD & Fullscreen */
        @media(max-width:640px) {
            #word-en { font-size: 40px; }
            .audio-btn { width: 44px; height: 44px; font-size: 24px; }
            #word-cn { font-size: 32px; }
            .definition { font-size: 16px; }
        }
        
        :fullscreen #learning-interface { padding: 20px; justify-content: center; height: 100vh; background: var(--bg); }
        :fullscreen .file-controls, :fullscreen h1, :fullscreen .toggle-setup-btn, :fullscreen .session-controls, :fullscreen .note { display: none; }
        :fullscreen .card-container { flex-grow: 1; margin-bottom: 20px; }
        :fullscreen #word-en { font-size: 80px; }
        :fullscreen .audio-btn { width: 80px; height: 80px; font-size: 48px; }
    </style>
</head>
<body>

    <div id="learning-interface">
        <h1>è‡ªè¨‚è©å½™å­¸ç¿’å¡ v8.8</h1>

        <button id="toggle-setup" class="toggle-setup-btn" onclick="toggleSetup()">âš™ï¸ åŒ¯å…¥ & è¨­å®š (é»æˆ‘å±•é–‹)</button>

        <div class="file-controls">
            <div style="margin-bottom:10px; border-bottom:1px dashed #ddd; padding-bottom:10px; display:flex; gap:5px; align-items:center;">
                <label>ğŸ“š ç‰Œçµ„ï¼š</label>
                <select id="deck-select" class="deck-select" onchange="changeDeck()"></select>
                <button class="small-btn" onclick="createNewDeck()">â•</button>
                <button class="small-btn" onclick="deleteDeck()" style="color:red;">ğŸ—‘ï¸</button>
            </div>

            <label>æ–¹æ³•ä¸€ï¼šåŒ¯å…¥ CSV</label>
            <div class="control-group">
                <input type="file" id="csvFileInput" accept=".csv"/>
                <button class="import-btn" onclick="importCSV()">åŒ¯å…¥</button>
            </div>
            
            <label>æ–¹æ³•äºŒï¼šè²¼ä¸Šå–®å­— (æ ¼å¼ï¼šè‹±æ–‡,ä¸­æ–‡)</label>
            <textarea id="paste-area" placeholder="ä¾‹å¦‚ï¼š\napple,è˜‹æœ\nbanana,é¦™è•‰"></textarea>
            <div style="display:flex; gap:8px; margin-bottom: 10px;">
                <button class="import-btn" onclick="importFromTextArea()">è²¼ä¸ŠåŒ¯å…¥</button>
                <button class="export-btn" onclick="exportUnknownWords()">åŒ¯å‡ºä¸æœƒ</button>
                <button class="import-btn challenge-btn" onclick="startErrorQuiz()">ğŸ”¥ éŒ¯é¡Œç‰¹è¨“</button>
            </div>
            
            <div class="management-btns" style="border-top:1px solid #eee; padding-top:10px;">
                <button class="small-btn" onclick="loadProgress(true)">ğŸ“‚ é‡æ–°è¼‰å…¥</button>
                <button class="small-btn" onclick="resetProgress()">ğŸ”„ é‡è¨­é€²åº¦</button>
                <button class="small-btn" onclick="clearProgress()">ğŸ§¹ æ¸…é™¤å…¨éƒ¨</button>
            </div>
        </div>

        <div class="session-controls">
            <div>
                <label><input type="checkbox" id="autoplay-audio-toggle" checked onchange="updateSettings()"> ğŸ”Š</label>
                <label>æ¬¡æ•¸:<select id="audio-play-count" onchange="updateSettings()" style="padding:4px;border-radius:4px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></label>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="small-btn" id="autoplay-toggle" onclick="toggleAutoplay()">â–¶ï¸ è‡ªå‹•</button>
                <button class="small-btn" onclick="toggleReviewMode()" id="review-toggle">ğŸ” è¤‡ç¿’</button>
                <button class="small-btn" onclick="toggleFullScreen()">ğŸ–¥ï¸ å…¨è¢å¹•</button>
                <button class="import-btn" onclick="startQuiz()">ğŸ§© æ¸¬é©—</button>
            </div>
        </div>

        <div class="progress-indicator">
            <div class="progress-info">é€²åº¦: <span id="current-index">0</span> / <span id="total-words">0</span> (æœªåˆ†é¡ <span id="unclassified-count">0</span>)</div>
            <div class="progress-bar-container"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
            <div class="status-summary">
                <button class="status-btn" onclick="showList('all')">ç¸½æ•¸: <span id="count-all">0</span></button>
                <button class="status-btn" style="color:var(--unknown)" onclick="showList('unknown')">âŒ: <span id="count-unknown">0</span></button>
                <button class="status-btn" style="color:var(--known)" onclick="showList('known')">âœ…: <span id="count-known">0</span></button>
            </div>
        </div>

        <div class="card-container" id="card-container">
            <div id="flashcard" class="flashcard">
                <div id="card-front" class="card-face card-front">
                    <div class="card-face-content">
                        <div class="srs-badge" id="srs-badge">New</div>
                        <div class="word-wrapper">
                            <div id="word-en">è«‹åŒ¯å…¥å–®å­—</div>
                            <div id="word-audio-btn" class="audio-btn">ğŸ”Š</div>
                        </div>
                        <div id="word-phonetic" class="phonetic"></div>
                    </div>
                </div>
                <div id="card-back" class="card-face card-back">
                    <div class="card-face-content">
                        <div id="word-cn">Welcome!</div>
                        <div id="word-definition" class="definition"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-row">
            <button class="nav-btn" onclick="prevCard()">â†‘</button>
            <button class="action-btn unknown-btn" onclick="markWord('unknown')">âŒ ä¸æœƒ (â†)</button>
            <button class="action-btn known-btn" onclick="markWord('known')">âœ… æœƒäº† (â†’)</button>
            <button class="nav-btn" onclick="nextCard()">â†“</button>
        </div>

        <p class="note">â† â†’ éµç›¤æ“ä½œ | ç©ºç™½éµç¿»é¢</p>
    </div>

    <div id="quiz-interface">
        <div id="quiz-question"></div>
        <div id="spell-hint-display" style="font-size:24px; font-weight:bold; color:var(--accent); margin-bottom:10px;"></div>
        <div id="quiz-options"></div>
        <p id="quiz-feedback" style="font-weight:700; text-align:center; margin-top:15px;"></p>
        <div style="display:flex; margin-top:20px;">
            <button class="small-btn" onclick="endQuiz()">çµæŸ</button>
            <div style="margin-left:auto" id="quiz-stats"></div>
        </div>
    </div>

    <div id="list-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="modal-title" style="margin:0">æ¸…å–®</h3>
                <button onclick="closeModal('list-modal')" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <ul id="word-list" class="word-list"></ul>
        </div>
    </div>

    <div id="quiz-setup-modal" class="modal">
        <div class="modal-content">
            <h3>æ¸¬é©—è¨­å®š</h3>
            <div style="margin-bottom:15px;">
                <p><strong>ç¯„åœï¼š</strong></p>
                <label><input type="radio" name="quizScope" value="all" checked> å…¨éƒ¨</label>
                <label><input type="radio" name="quizScope" value="unknown"> åªæ¸¬ä¸æœƒ</label>
                <label><input type="radio" name="quizScope" value="hard"> å¸¸éŒ¯å­—</label>
            </div>
            <div style="margin-bottom:15px;">
                <p><strong>é¡Œå‹ï¼š</strong></p>
                <label><input type="radio" name="quizType" value="e-c-select" checked> è‹±é¸ä¸­</label>
                <label><input type="radio" name="quizType" value="c-e-select"> ä¸­é¸è‹±</label>
                <label><input type="radio" name="quizType" value="e-c-spell"> æ‹¼å¯«</label>
            </div>
            <button class="import-btn" style="width:100%; padding:12px;" onclick="runQuiz()">é–‹å§‹æ¸¬é©—</button>
            <button class="small-btn" style="width:100%; margin-top:10px;" onclick="closeModal('quiz-setup-modal')">å–æ¶ˆ</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- Data Variables ---
        let decks = {"Default": []}, currentDeckName = "Default", vocabulary = [], currentIndex = 0;
        let reviewOnlyUnknown = false, isAutoplaying = false;
        let settings = { autoPlay: true, playCount: 1, speed: 3000 };
        let quizActive = false, quizList = [], quizIndex = 0, quizScore = 0, quizWrong = 0;
        let quizType = 'e-c-select', currentSpellHintWord = '', spellHintLen = 0;

        const DOM = {};

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const ids = ['flashcard','word-en','word-phonetic','word-audio-btn','word-cn','word-definition',
                         'audio-player','list-modal','word-list','modal-title','deck-select',
                         'count-all','count-known','count-unknown','current-index','total-words','unclassified-count','progress-bar-fill',
                         'learning-interface','quiz-interface','quiz-question','quiz-options','quiz-feedback','quiz-stats', 'toggle-setup'];
            ids.forEach(id => DOM[id] = document.getElementById(id));

            if(DOM.flashcard) DOM.flashcard.addEventListener('click', flipCard);
            
            loadData();
            updateDeckSelectUI();
            displayCard(currentIndex);
            updateStatusDisplay();
            
            // Setup Toggle Button
            if(DOM['toggle-setup']) {
                DOM['toggle-setup'].textContent = 'âš™ï¸ åŒ¯å…¥ & è¨­å®š (é»æˆ‘å±•é–‹)';
            }

            // Fullscreen change listener
            document.addEventListener('fullscreenchange', () => {
                // No specific class toggling needed if we use :fullscreen pseudo-class in CSS
            });
        });

        // --- Core Functions ---
        function toggleSetup() {
            const el = document.querySelector('.file-controls');
            const btn = DOM['toggle-setup'];
            if(el.style.display === 'block') { 
                el.style.display = 'none'; 
                if(btn) btn.textContent = 'âš™ï¸ åŒ¯å…¥ & è¨­å®š (é»æˆ‘å±•é–‹)'; 
            } else { 
                el.style.display = 'block'; 
                if(btn) btn.textContent = 'âš™ï¸ åŒ¯å…¥ & è¨­å®š (é»æˆ‘æ”¶åˆ)'; 
            }
        }

        function loadData() {
            try {
                const d = localStorage.getItem('vocab_v8_decks');
                if(d) decks = JSON.parse(d);
                const c = localStorage.getItem('vocab_v8_current');
                if(c && decks[c]) currentDeckName = c;
                // Initialize default if empty
                if(!decks[currentDeckName]) decks[currentDeckName] = [];
                vocabulary = decks[currentDeckName];
            } catch(e) { console.error(e); }
        }

        function saveData() {
            localStorage.setItem('vocab_v8_decks', JSON.stringify(decks));
            localStorage.setItem('vocab_v8_current', currentDeckName);
        }

        function updateStatusDisplay() {
            if(!DOM['count-all']) return;
            DOM['count-all'].textContent = vocabulary.length;
            DOM['count-known'].textContent = vocabulary.filter(w => w.status === 'known').length;
            DOM['count-unknown'].textContent = vocabulary.filter(w => w.status === 'unknown').length;
            DOM['unclassified-count'].textContent = vocabulary.filter(w => w.status === 'unclassified').length;
            DOM['total-words'].textContent = vocabulary.length;
            
            const current = (vocabulary.length > 0) ? currentIndex + 1 : 0;
            DOM['current-index'].textContent = current;

            const classified = vocabulary.filter(w => w.status !== 'unclassified').length;
            const pct = vocabulary.length ? Math.round((classified / vocabulary.length) * 100) : 0;
            DOM['progress-bar-fill'].style.width = pct + '%';
        }

        async function displayCard(index) {
            if(vocabulary.length === 0) {
                DOM['word-en'].textContent = "è«‹åŒ¯å…¥å–®å­—";
                DOM['word-cn'].textContent = "Import List";
                DOM['word-phonetic'].textContent = "";
                DOM['word-definition'].textContent = "";
                return;
            }
            
            if(index < 0) index = vocabulary.length - 1;
            if(index >= vocabulary.length) index = 0;
            currentIndex = index;

            const w = vocabulary[index];
            DOM['word-en'].textContent = w.en;
            DOM['word-cn'].textContent = w.cn;
            DOM['word-phonetic'].textContent = "...";
            DOM['word-definition'].textContent = "";
            if(document.getElementById('srs-badge')) {
                document.getElementById('srs-badge').textContent = "Lv." + (w.srsLevel || 0);
            }
            
            if(DOM.flashcard) DOM.flashcard.classList.remove('flipped');
            updateStatusDisplay();

            // Fetch Data
            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w.en)}`);
                if(res.ok) {
                    const data = await res.json();
                    const entry = data[0];
                    // Phonetic
                    let ph = entry.phonetic || '';
                    if(!ph && entry.phonetics) {
                         const p = entry.phonetics.find(x => x.text);
                         if(p) ph = p.text;
                    }
                    DOM['word-phonetic'].textContent = ph;

                    // Audio
                    let audio = null;
                    if(entry.phonetics) {
                        const a = entry.phonetics.find(x => x.audio);
                        if(a) audio = a.audio;
                    }
                    
                    // Definition
                    if(entry.meanings) {
                         let def = '';
                         for(let m of entry.meanings) {
                             if(m.definitions && m.definitions[0].definition) {
                                 def = m.definitions[0].definition;
                                 break;
                             }
                         }
                         DOM['word-definition'].textContent = def;
                    }

                    DOM['word-audio-btn'].onclick = (e) => {
                        e.stopPropagation();
                        playAudio(w.en, audio);
                    };
                    
                    if(settings.autoPlay && !isAutoplaying && !quizActive) {
                         playAudio(w.en, audio);
                    }
                } else {
                     // API fail fallback
                     DOM['word-phonetic'].textContent = "";
                     DOM['word-audio-btn'].onclick = (e) => { e.stopPropagation(); speakTTS(w.en); };
                }
            } catch(e) { 
                DOM['word-phonetic'].textContent = "";
                DOM['word-audio-btn'].onclick = (e) => { e.stopPropagation(); speakTTS(w.en); };
            }
        }

        function playAudio(word, url) {
            const count = parseInt(document.getElementById('audio-play-count').value) || 1;
            let played = 0;
            
            const play = () => {
                if(played >= count) return;
                played++;
                if(url) {
                    DOM['audio-player'].src = url;
                    DOM['audio-player'].onended = play;
                    DOM['audio-player'].onerror = () => speakTTS(word, play); // Fallback to TTS
                    DOM['audio-player'].play().catch(() => speakTTS(word, play));
                } else {
                    speakTTS(word, play);
                }
            };
            play();
        }

        function speakTTS(text, callback) {
            if(!window.speechSynthesis) { if(callback) callback(); return; }
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            if(callback) u.onend = callback;
            window.speechSynthesis.speak(u);
        }

        // --- Navigation ---
        function nextCard() { 
            if(reviewOnlyUnknown) {
                let i = (currentIndex + 1) % vocabulary.length;
                let loop = 0;
                while(vocabulary[i].status !== 'unknown' && loop < vocabulary.length) {
                    i = (i + 1) % vocabulary.length;
                    loop++;
                }
                if(loop < vocabulary.length) displayCard(i);
                else { alert("æ²’æœ‰ã€Œä¸æœƒã€çš„å–®å­—äº†ï¼"); displayCard(currentIndex); }
            } else {
                displayCard(currentIndex + 1); 
            }
        }
        function prevCard() { displayCard(currentIndex - 1); }
        function flipCard() { if(!isAutoplaying) DOM.flashcard.classList.toggle('flipped'); }
        
        function markWord(status) {
            if(vocabulary.length === 0) return;
            vocabulary[currentIndex].status = status;
            if(status === 'unknown') vocabulary[currentIndex].errorCount = (vocabulary[currentIndex].errorCount || 0) + 1;
            
            // Simple SRS logic
            if(status === 'known') vocabulary[currentIndex].srsLevel = (vocabulary[currentIndex].srsLevel || 0) + 1;
            else vocabulary[currentIndex].srsLevel = 0;

            saveData();
            nextCard();
        }

        // --- List Modal ---
        function showList(filter) {
            if(vocabulary.length === 0) return alert("ç„¡è³‡æ–™");
            DOM['word-list'].innerHTML = '';
            let data = [];
            
            if(filter === 'all') data = vocabulary;
            else if(filter === 'known') data = vocabulary.filter(w => w.status === 'known');
            else if(filter === 'unknown') data = vocabulary.filter(w => w.status === 'unknown');

            data.forEach(w => {
                const li = document.createElement('li');
                const icon = w.status === 'known' ? 'âœ…' : (w.status === 'unknown' ? 'âŒ' : 'âšª');
                li.textContent = `${icon} ${w.en} ${w.cn}`;
                DOM['word-list'].appendChild(li);
            });
            
            DOM['modal-title'].textContent = filter === 'all' ? 'ç¸½è©å½™è¡¨' : (filter === 'known' ? 'å·²å­¸æœƒ' : 'éœ€è¤‡ç¿’');
            document.getElementById('list-modal').classList.add('show');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        // --- Import ---
        function importFromTextArea() {
            const txt = document.getElementById('paste-area').value;
            if(!txt) return;
            const lines = txt.split(/\n/);
            let added = 0;
            lines.forEach(l => {
                // Split by comma OR tab
                const p = l.split(/,|\t/);
                if(p.length >= 2) {
                    let en = p[0].trim();
                    let cn = p[1].trim();
                    // Clean quotes
                    en = en.replace(/^"|"$/g, '');
                    cn = cn.replace(/^"|"$/g, '');
                    
                    if(en && cn && !vocabulary.some(v=>v.en===en)) {
                        vocabulary.push({en, cn, status: 'unclassified', errorCount: 0, srsLevel: 0});
                        added++;
                    }
                }
            });
            if(added > 0) {
                saveData(); displayCard(0); updateStatusDisplay(); alert(`åŒ¯å…¥ ${added} å€‹å–®å­—`);
                document.getElementById('paste-area').value = '';
                toggleSetup(); // Auto collapse
            } else {
                alert("æœªæ‰¾åˆ°æœ‰æ•ˆå–®å­—æ ¼å¼ (è‹±æ–‡,ä¸­æ–‡)");
            }
        }
        
        function importCSV() {
             const file = document.getElementById('csvFileInput').files[0];
             if(!file) return;
             const r = new FileReader();
             r.onload = e => {
                 document.getElementById('paste-area').value = e.target.result;
                 importFromTextArea();
             };
             r.readAsText(file);
        }

        function exportUnknownWords() {
             const data = vocabulary.filter(w => w.status === 'unknown').map(w => `${w.en},${w.cn}`).join('\n');
             const blob = new Blob([data], {type: 'text/plain'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url; a.download = 'unknown.txt'; a.click();
        }

        // --- Decks ---
        function updateDeckSelectUI() {
            const sel = document.getElementById('deck-select');
            sel.innerHTML = '';
            Object.keys(decks).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = `${k} (${decks[k].length})`;
                if(k === currentDeckName) opt.selected = true;
                sel.appendChild(opt);
            });
        }
        function changeDeck() {
            currentDeckName = document.getElementById('deck-select').value;
            vocabulary = decks[currentDeckName];
            currentIndex = 0;
            displayCard(0);
            updateStatusDisplay();
            saveData();
        }
        function createNewDeck() {
            const n = prompt("ç‰Œçµ„åç¨±:");
            if(n && !decks[n]) { decks[n] = []; currentDeckName = n; vocabulary = []; updateDeckSelectUI(); saveData(); displayCard(0); updateStatusDisplay(); }
        }
        function deleteDeck() {
            if(Object.keys(decks).length === 1) return alert("ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹ç‰Œçµ„");
            if(confirm(`åˆªé™¤ ${currentDeckName}?`)) {
                delete decks[currentDeckName];
                currentDeckName = Object.keys(decks)[0];
                vocabulary = decks[currentDeckName];
                currentIndex = 0;
                updateDeckSelectUI(); saveData(); displayCard(0); updateStatusDisplay();
            }
        }
        
        function resetProgress() {
             if(confirm("é‡è¨­é€²åº¦ï¼Ÿ")) {
                 vocabulary.forEach(w => w.status = 'unclassified');
                 saveData(); displayCard(0); updateStatusDisplay();
             }
        }
        function clearProgress() {
             if(confirm("æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); }
        }

        // --- Other UI ---
        function toggleReviewMode() {
            reviewOnlyUnknown = !reviewOnlyUnknown;
            document.getElementById('review-toggle').textContent = reviewOnlyUnknown ? "ğŸ” é€€å‡ºè¤‡ç¿’" : "ğŸ” åªçœ‹ä¸æœƒ";
            nextCard(); // Jump to next appropriate card
        }
        
        function toggleFullScreen() {
            if(!document.fullscreenElement) {
                 if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                 else if(document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen(); // Safari
            } else {
                 if(document.exitFullscreen) document.exitFullscreen();
                 else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        }
        
        function updateSettings() {
             settings.autoPlay = document.getElementById('autoplay-audio-toggle').checked;
        }
        
        // --- Autoplay ---
        function toggleAutoplay() {
             if(isAutoplaying) {
                 isAutoplaying = false;
                 document.getElementById('autoplay-toggle').textContent = "â–¶ï¸ è‡ªå‹•";
             } else {
                 if(vocabulary.length === 0) return;
                 isAutoplaying = true;
                 document.getElementById('autoplay-toggle').textContent = "â¸ï¸ æš«åœ";
                 runAutoplayLoop();
             }
        }
        
        async function runAutoplayLoop() {
             if(!isAutoplaying) return;
             await displayCard(currentIndex);
             setTimeout(() => {
                 if(!isAutoplaying) return;
                 DOM.flashcard.classList.add('flipped');
                 setTimeout(() => {
                     if(!isAutoplaying) return;
                     nextCard();
                     runAutoplayLoop();
                 }, 3000);
             }, 3000);
        }

        // --- Quiz ---
        function startQuiz() {
             if(vocabulary.length === 0) return alert("ç„¡å–®å­—");
             document.getElementById('quiz-setup-modal').classList.add('show');
        }
        function startErrorQuiz() {
             const list = vocabulary.filter(w => (w.errorCount || 0) > 0);
             if(list.length === 0) return alert("ç„¡éŒ¯é¡Œç´€éŒ„");
             initQuiz(list, 'e-c-select');
        }
        
        function runQuiz() {
             closeModal('quiz-setup-modal');
             const scope = document.querySelector('input[name="quizScope"]:checked').value;
             quizType = document.querySelector('input[name="quizType"]:checked').value;
             
             let list = [];
             if(scope === 'all') list = [...vocabulary];
             else if(scope === 'unknown') list = vocabulary.filter(w => w.status === 'unknown');
             else if(scope === 'hard') list = vocabulary.filter(w => (w.errorCount || 0) > 0);
             
             if(list.length === 0) return alert("ç„¡ç¬¦åˆå–®å­—");
             list.sort(() => 0.5 - Math.random());
             initQuiz(list, quizType);
        }

        function initQuiz(list, type) {
             quizActive = true;
             quizList = list;
             quizIndex = 0; quizScore = 0; quizWrong = 0;
             DOM['learning-interface'].style.display = 'none';
             DOM['quiz-interface'].style.display = 'block';
             renderQuizQuestion();
        }

        function renderQuizQuestion() {
             if(quizIndex >= quizList.length) {
                 alert(`æ¸¬é©—çµæŸï¼åˆ†æ•¸: ${quizScore}`);
                 endQuiz();
                 return;
             }
             const w = quizList[quizIndex];
             const qEl = DOM['quiz-question'];
             const oEl = DOM['quiz-options'];
             oEl.innerHTML = '';
             document.getElementById('spell-hint-display').textContent = ''; // Clear hint
             
             let qText = '', ans = '';
             if(quizType === 'e-c-select') { qText = w.en; ans = w.cn; }
             else if(quizType === 'c-e-select') { qText = w.cn; ans = w.en; }
             else if(quizType === 'e-c-spell') { qText = w.cn; ans = w.en; }
             
             qEl.innerHTML = `<div style="font-size:14px;color:#666">é¡Œç›® ${quizIndex+1}/${quizList.length}</div><div style="font-size:32px;color:blue;margin:10px 0">${qText}</div>`;
             
             if(quizType === 'e-c-spell') {
                  // Spell input layout
                  oEl.innerHTML = `
                      <input type="text" id="spell-input" autocomplete="off" style="font-size:20px;padding:8px;width:100%;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;">
                      <div style="display:flex;gap:10px;">
                          <button class="small-btn" onclick="showSpellHint()">ğŸ’¡ æç¤º</button>
                          <button class="import-btn" style="flex-grow:1;" onclick="checkAnswer()">é€å‡º</button>
                      </div>
                  `;
                  currentSpellHintWord = w.en;
                  spellHintRevealedCount = 0;
                  setTimeout(()=>document.getElementById('spell-input').focus(), 100);
             } else {
                  // Options layout
                  const opts = [ans];
                  while(opts.length < 3 && vocabulary.length >= 3) {
                      const r = vocabulary[Math.floor(Math.random() * vocabulary.length)];
                      const val = (quizType === 'e-c-select') ? r.cn : r.en;
                      if(!opts.includes(val)) opts.push(val);
                  }
                  opts.sort(() => 0.5 - Math.random());
                  opts.forEach(o => {
                      const btn = document.createElement('button');
                      btn.textContent = o;
                      btn.onclick = () => checkAnswer(o);
                      oEl.appendChild(btn);
                  });
             }
        }
        
        function showSpellHint() {
             if(spellHintRevealedCount < currentSpellHintWord.length) {
                 spellHintRevealedCount++;
                 document.getElementById('spell-hint-display').textContent = currentSpellHintWord.substring(0, spellHintRevealedCount);
                 document.getElementById('spell-input').focus();
             }
        }

        function checkAnswer(val) {
             if(!val) { // Spelling case
                 const inp = document.getElementById('spell-input');
                 if(inp) val = inp.value;
             }
             
             const w = quizList[quizIndex];
             let correct = false;
             
             if(quizType === 'e-c-select') correct = (val === w.cn);
             else correct = (val && val.toLowerCase().trim() === w.en.toLowerCase().trim());
             
             const fb = document.getElementById('quiz-feedback');
             if(correct) {
                 fb.textContent = "âœ… æ­£ç¢º"; fb.style.color = "green"; quizScore++;
                 if(w.errorCount > 0) w.errorCount--;
             } else {
                 fb.textContent = `âŒ éŒ¯èª¤! æ­£è§£: ${w.en} ${w.cn}`; fb.style.color = "red"; quizWrong++;
                 w.errorCount = (w.errorCount || 0) + 1;
             }
             saveData();
             setTimeout(() => { fb.textContent = ""; quizIndex++; renderQuizQuestion(); }, 2000);
        }

        function endQuiz() {
             quizActive = false;
             DOM['quiz-interface'].style.display = 'none';
             DOM['learning-interface'].style.display = 'flex';
             displayCard(currentIndex);
        }

        document.addEventListener('keydown', e => {
             if(document.querySelector('.modal.show')) return;
             if(e.target.id === 'paste-area') return;
             
             if(quizActive) {
                 if(e.key === 'Enter' && quizType === 'e-c-spell') checkAnswer();
                 return;
             }
             if(e.key === 'ArrowRight') markWord('known');
             if(e.key === 'ArrowLeft') markWord('unknown');
             if(e.key === 'ArrowUp') prevCard();
             if(e.key === 'ArrowDown') nextCard();
             if(e.key === ' ') flipCard();
        });
    </script>
</body>
</html>
